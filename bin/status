#!/usr/bin/env bash
set -euo pipefail

CORTEX_HOME="${CORTEX_HOME:-$HOME/.cortex}"
INGEST_PID_FILE="$CORTEX_HOME/ingestor/ingestor.pid"
CH_PID_FILE="$CORTEX_HOME/clickhouse/clickhouse.pid"
LAUNCHD_DOMAIN="gui/$(id -u)"
CLICKHOUSE_LABEL="com.eric.cortex.clickhouse"
INGESTOR_LABEL="com.eric.cortex.ingestor"

launchd_state() {
  local label="$1"
  local output
  if ! output="$(launchctl print "$LAUNCHD_DOMAIN/$label" 2>/dev/null)"; then
    return 1
  fi
  if printf '%s\n' "$output" | grep -q "state = running"; then
    echo "running (launchd)"
    return 0
  fi
  if printf '%s\n' "$output" | grep -q "state = waiting"; then
    echo "waiting (launchd)"
    return 0
  fi
  echo "loaded (launchd)"
  return 0
}

CLICKHOUSE_OK=0
if curl -fsS "http://127.0.0.1:8123/?query=SELECT%201" >/dev/null 2>&1; then
  CLICKHOUSE_OK=1
fi

if [[ -f "$CH_PID_FILE" ]] && kill -0 "$(cat "$CH_PID_FILE")" 2>/dev/null; then
  echo "clickhouse: running (pid $(cat "$CH_PID_FILE"))"
elif ch_state="$(launchd_state "$CLICKHOUSE_LABEL")"; then
  echo "clickhouse: $ch_state"
elif [[ "$CLICKHOUSE_OK" -eq 1 ]]; then
  echo "clickhouse: running (healthcheck)"
else
  echo "clickhouse: stopped"
fi

if [[ "$CLICKHOUSE_OK" -eq 1 ]]; then
  echo "clickhouse health: ok"
else
  echo "clickhouse health: unavailable"
fi

INGEST_RUNNING=0
if [[ -f "$INGEST_PID_FILE" ]] && kill -0 "$(cat "$INGEST_PID_FILE")" 2>/dev/null; then
  echo "ingestor: running (pid $(cat "$INGEST_PID_FILE"))"
  INGEST_RUNNING=1
elif ing_state="$(launchd_state "$INGESTOR_LABEL")"; then
  echo "ingestor: $ing_state"
  INGEST_RUNNING=1
fi

HB_TABLE=0
LAST_HB=""
LAST_HB_EPOCH=0
if [[ "$CLICKHOUSE_OK" -eq 1 ]]; then
  HB_TABLE="$(curl -fsS "http://127.0.0.1:8123/?query=SELECT%20count()%20FROM%20system.tables%20WHERE%20database='cortex'%20AND%20name='ingest_heartbeats'")"
  if [[ "$HB_TABLE" != "0" ]]; then
    LAST_HB="$(curl -fsS "http://127.0.0.1:8123/?query=SELECT%20max(ts)%20FROM%20cortex.ingest_heartbeats")"
    LAST_HB_EPOCH="$(curl -fsS "http://127.0.0.1:8123/?query=SELECT%20toUnixTimestamp(max(ts))%20FROM%20cortex.ingest_heartbeats")"
  fi
fi

if [[ "$INGEST_RUNNING" -eq 0 ]] && [[ "$LAST_HB_EPOCH" =~ ^[0-9]+$ ]] && [[ "$LAST_HB_EPOCH" -gt 0 ]]; then
  NOW_EPOCH="$(date +%s)"
  if (( NOW_EPOCH - LAST_HB_EPOCH <= 20 )); then
    echo "ingestor: running (heartbeat)"
    INGEST_RUNNING=1
  fi
fi

if [[ "$INGEST_RUNNING" -eq 0 ]]; then
  echo "ingestor: stopped"
fi

if [[ "$CLICKHOUSE_OK" -eq 1 ]]; then
  RAW_COUNT="$(curl -fsS "http://127.0.0.1:8123/?query=SELECT%20count()%20FROM%20cortex.raw_events")"
  EVENT_COUNT="$(curl -fsS "http://127.0.0.1:8123/?query=SELECT%20count()%20FROM%20cortex.events")"
  echo "raw_events: $RAW_COUNT"
  echo "events: $EVENT_COUNT"
fi

if [[ "$HB_TABLE" != "0" ]] && [[ -n "$LAST_HB" ]]; then
  echo "last_heartbeat: $LAST_HB"
fi

if [[ "$CLICKHOUSE_OK" -eq 1 ]]; then
  echo "ping: ok"
else
  echo "ping: unavailable"
fi
