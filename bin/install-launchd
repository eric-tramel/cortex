#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
LOG_DIR="$HOME/.cortex/launchd"
mkdir -p "$LAUNCH_AGENTS_DIR" "$LOG_DIR"

CLICKHOUSE_LABEL="com.eric.cortex.clickhouse"
INGESTOR_LABEL="com.eric.cortex.ingestor"
CLICKHOUSE_PLIST="$LAUNCH_AGENTS_DIR/$CLICKHOUSE_LABEL.plist"
INGESTOR_PLIST="$LAUNCH_AGENTS_DIR/$INGESTOR_LABEL.plist"

cat > "$CLICKHOUSE_PLIST" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>$CLICKHOUSE_LABEL</string>

  <key>ProgramArguments</key>
  <array>
    <string>$PROJECT_ROOT/bin/run-clickhouse-service</string>
  </array>

  <key>EnvironmentVariables</key>
  <dict>
    <key>PATH</key>
    <string>$HOME/.nix-profile/bin:$HOME/.npm-global/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    <key>CORTEX_HOME</key>
    <string>$HOME/.cortex</string>
  </dict>

  <key>RunAtLoad</key>
  <true/>

  <key>KeepAlive</key>
  <true/>

  <key>WorkingDirectory</key>
  <string>$PROJECT_ROOT</string>

  <key>StandardOutPath</key>
  <string>$LOG_DIR/clickhouse.out.log</string>

  <key>StandardErrorPath</key>
  <string>$LOG_DIR/clickhouse.err.log</string>
</dict>
</plist>
PLIST

cat > "$INGESTOR_PLIST" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>$INGESTOR_LABEL</string>

  <key>ProgramArguments</key>
  <array>
    <string>$PROJECT_ROOT/bin/run-ingestor-rust-service</string>
  </array>

  <key>EnvironmentVariables</key>
  <dict>
    <key>PATH</key>
    <string>$HOME/.nix-profile/bin:$HOME/.npm-global/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    <key>CORTEX_HOME</key>
    <string>$HOME/.cortex</string>
  </dict>

  <key>RunAtLoad</key>
  <true/>

  <key>KeepAlive</key>
  <true/>

  <key>WorkingDirectory</key>
  <string>$PROJECT_ROOT</string>

  <key>StandardOutPath</key>
  <string>$LOG_DIR/ingestor.out.log</string>

  <key>StandardErrorPath</key>
  <string>$LOG_DIR/ingestor.err.log</string>
</dict>
</plist>
PLIST

DOMAIN="gui/$(id -u)"

bootout_label() {
  local label="$1"
  launchctl bootout "$DOMAIN/$label" >/dev/null 2>&1 || true
}

bootstrap_plist() {
  local plist="$1"
  if launchctl bootstrap "$DOMAIN" "$plist" >/dev/null 2>&1; then
    return 0
  fi
  launchctl unload "$plist" >/dev/null 2>&1 || true
  if launchctl load -w "$plist" >/dev/null 2>&1; then
    return 0
  fi
  echo "Failed to register LaunchAgent: $plist" >&2
  return 1
}

bootout_label "$CLICKHOUSE_LABEL"
bootout_label "$INGESTOR_LABEL"

bootstrap_plist "$CLICKHOUSE_PLIST"
bootstrap_plist "$INGESTOR_PLIST"

launchctl enable "$DOMAIN/$CLICKHOUSE_LABEL" >/dev/null 2>&1 || true
launchctl enable "$DOMAIN/$INGESTOR_LABEL" >/dev/null 2>&1 || true
launchctl kickstart -k "$DOMAIN/$CLICKHOUSE_LABEL" >/dev/null 2>&1 || true
launchctl kickstart -k "$DOMAIN/$INGESTOR_LABEL" >/dev/null 2>&1 || true

echo "Installed and started launchd agents:"
echo "- $CLICKHOUSE_LABEL"
echo "- $INGESTOR_LABEL"
echo "Plists:"
echo "- $CLICKHOUSE_PLIST"
echo "- $INGESTOR_PLIST"
