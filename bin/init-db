#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_PATH="${CORTEX_CONFIG:-$HOME/.cortex/config.toml}"
SQL_DIR="$PROJECT_ROOT/sql"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --config)
      CONFIG_PATH="$2"
      shift 2
      ;;
    --sql-dir)
      SQL_DIR="$2"
      shift 2
      ;;
    *)
      echo "unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

if [[ ! -f "$CONFIG_PATH" ]]; then
  mkdir -p "$(dirname "$CONFIG_PATH")"
  cp "$PROJECT_ROOT/config/cortex.toml" "$CONFIG_PATH"
fi

if [[ ! -d "$SQL_DIR" ]]; then
  echo "sql directory not found: $SQL_DIR" >&2
  exit 1
fi

toml_get() {
  local section="$1"
  local key="$2"
  local file="$3"
  awk -v section="$section" -v key="$key" '
    BEGIN { in_section = 0 }

    /^[[:space:]]*#/ { next }

    $0 ~ "^[[:space:]]*\\[" section "\\][[:space:]]*$" {
      in_section = 1
      next
    }

    $0 ~ "^[[:space:]]*\\[[^]]+\\][[:space:]]*$" {
      in_section = 0
    }

    in_section && $0 ~ "^[[:space:]]*" key "[[:space:]]*=" {
      value = $0
      sub(/^[^=]*=[[:space:]]*/, "", value)
      sub(/[[:space:]]+#.*$/, "", value)
      gsub(/^"/, "", value)
      gsub(/"$/, "", value)
      print value
      exit
    }
  ' "$file"
}

CLICKHOUSE_URL="$(toml_get "clickhouse" "url" "$CONFIG_PATH")"
CLICKHOUSE_DB="$(toml_get "clickhouse" "database" "$CONFIG_PATH")"

CLICKHOUSE_URL="${CLICKHOUSE_URL:-http://127.0.0.1:8123}"
CLICKHOUSE_DB="${CLICKHOUSE_DB:-cortex}"

if ! curl -fsS "$CLICKHOUSE_URL/?query=SELECT%201" >/dev/null 2>&1; then
  echo "clickhouse is unavailable at $CLICKHOUSE_URL" >&2
  exit 1
fi

execute_statement() {
  local statement="$1"
  statement="$(printf '%s' "$statement" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
  if [[ -z "$statement" ]]; then
    return 0
  fi
  curl -fsS --data-binary "$statement" "$CLICKHOUSE_URL/?database=$CLICKHOUSE_DB" >/dev/null
}

have_sql_files=0
while IFS= read -r sql_file; do
  [[ -z "$sql_file" ]] && continue
  have_sql_files=1
  buffer=""
  while IFS= read -r line || [[ -n "$line" ]]; do
    buffer+="$line"$'\n'
    while [[ "$buffer" == *";"* ]]; do
      statement="${buffer%%;*}"
      buffer="${buffer#*;}"
      execute_statement "$statement"
    done
  done < "$sql_file"

  execute_statement "$buffer"
done < <(find "$SQL_DIR" -maxdepth 1 -type f -name '*.sql' | sort)

if [[ "$have_sql_files" -eq 0 ]]; then
  echo "no sql files found in $SQL_DIR" >&2
  exit 1
fi

echo "schema initialized in $CLICKHOUSE_DB"
