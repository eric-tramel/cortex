#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_PATH="${CORTEX_CONFIG:-$HOME/.cortex/config.toml}"
BINARY_PATH="$PROJECT_ROOT/rust/ingestor/target/release/cortex-ingestor"

if [[ ! -f "$CONFIG_PATH" ]]; then
  mkdir -p "$(dirname "$CONFIG_PATH")"
  cp "$PROJECT_ROOT/config/cortex.toml" "$CONFIG_PATH"
fi

for _ in $(seq 1 180); do
  if curl -fsS "http://127.0.0.1:8123/?query=SELECT%201" >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

if ! curl -fsS "http://127.0.0.1:8123/?query=SELECT%201" >/dev/null 2>&1; then
  echo "clickhouse is unavailable; ingestor exiting"
  exit 1
fi

"$PROJECT_ROOT/bin/init-db" --config "$CONFIG_PATH"

if [[ ! -x "$BINARY_PATH" ]]; then
  echo "rust ingestor binary not found at $BINARY_PATH"
  echo "build it with: $PROJECT_ROOT/bin/build-rust-ingestor"
  exit 1
fi

exec "$BINARY_PATH" --config "$CONFIG_PATH"
